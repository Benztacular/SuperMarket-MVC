<%
  // normalize product fields (fallbacks)
  const p = product || {};
  const productName = p.productName || p.name || 'Product';
  const price = (p.price != null) ? Number(p.price).toFixed(2) : '0.00';
  const qty = (p.quantity != null) ? p.quantity : (p.stock != null ? p.stock : 'N/A');
  const imageSrc = p.image ? ('/images/' + p.image) : '/images/placeholder.png';

  const u = (typeof user !== 'undefined' && user) ? user : (locals.user || null);
  const isAdmin = (typeof locals.isAdmin !== 'undefined') ? locals.isAdmin : !!(u && u.role === 'admin');
  const backHref = isAdmin ? '/inventory' : '/shopping';
%>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= productName %></title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    /* Page background */
    .product-wrapper { 
      padding: 40px 0; 
      background: #f5f7fa;
    }

    /* Main product card */
    .product-card { 
      background:#fff; 
      border:1px solid #e3e6eb; 
      border-radius:16px; 
      padding:32px; 
      box-shadow: 0 8px 24px rgba(0,0,0,0.05); 
    }

    /* Layout spacing */
    .product-card .d-flex { 
      gap: 40px; 
      align-items: flex-start; 
    }

    /* Image container */
    .product-card .flex-shrink-0 { 
      min-width: 380px; 
      max-width: 420px; 
    }

    /* Product image box */
    .product-img { 
      width:100%; 
      height:420px; 
      object-fit:contain; 
      display:block; 
      background:#fff; 
      border-radius:18px; 
      padding:40px; 
      border:1px solid #eef1f4;
    }

    /* Title */
    .product-card h2 { 
      font-size: 34px; 
      font-weight: 800; 
      color: #0a1a2b; 
      margin-bottom: 12px;
    }

    /* Info rows */
    .meta-row dt { 
      width: 45%; 
      font-weight: 600; 
      color:#5d6b7a; 
    }
    .meta-row dd { 
      color:#0f1720; 
      font-weight: 600;
    }

    /* Pricing styling if needed later */
    .price-current { 
      font-size: 32px; 
      color: #12b76a; 
      font-weight:800; 
    }
    .price-old { 
      font-size:16px; 
      color:#9aa0a6; 
      text-decoration: line-through; 
      margin-left:8px;
    }
    .price-sub { 
      color:#6b7280; 
      font-size:14px; 
      margin-left:6px; 
    }

    /* Add-to-cart UI */
    .add-cart-box .input-group { 
      border-radius:50px; 
      overflow:hidden; 
      border:1px solid #dfe5ea; 
      box-shadow: 0 6px 20px rgba(0,0,0,0.05); 
    }

    .add-cart-box .form-control[type="number"] { 
      max-width:120px; 
      padding:14px 18px; 
      border:0; 
      font-weight:700; 
      font-size:16px; 
    }

    .add-cart-box .btn.btn-primary {
      background: #00b96b; 
      border:0;
      color:#fff;
      padding:16px 26px;
      font-weight:800;
      border-radius:0 50px 50px 0;
      font-size:16px;
      box-shadow: 0 10px 25px rgba(0,185,107,0.22);
    }

    .btn.btn-link { 
      color:#6b7280; 
      font-weight:600; 
    }

    /* Responsive */
    @media (max-width:991px) {
      .product-card .flex-shrink-0 { min-width: 200px; }
      .product-img { height:260px; padding:20px; }
    }

    @media (max-width:767px) {
      .product-card { padding:20px; }
      .product-card h2 { font-size:24px; }
      .price-current { font-size:22px; }
      .add-cart-box .btn.btn-primary { padding:12px 16px; }
    }
  </style>
</head>
<body>

  <%- include('partials/header') %>

  <div class="container product-wrapper">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8 product-card">

        <div class="d-flex flex-column flex-md-row align-items-center gap-4">

          <!-- IMAGE -->
          <div class="flex-shrink-0 text-center">
            <img src="<%= imageSrc %>" 
                 alt="<%= productName %>" 
                 class="img-fluid product-img"
                 onerror="this.onerror=null;this.src='/images/placeholder.png'">
          </div>

          <!-- DETAILS -->
          <div class="flex-grow-1 w-100">

            <h2 class="mb-2"><%= productName %></h2>

            <dl class="row meta-row mb-3">
              <dt class="col-5">Product Quantity:</dt>
              <dd class="col-7"><%= qty %></dd>

              <dt class="col-5">Price:</dt>
              <dd class="col-7">$<%= price %></dd>
            </dl>

            <!-- ADD TO CART -->
            <div class="add-cart-box mb-3" style="max-width:360px;">
              <form action="/cart/add" method="post" class="d-flex align-items-center mb-0 w-100">
                <input type="hidden" name="product_id" value="<%= p.id %>">

                <div class="input-group">
                  <input type="number" 
                         name="quantity" 
                         class="form-control" 
                         min="1" 
                         value="1" 
                         aria-label="Quantity">
                  <button class="btn btn-primary" type="submit">
                    Add to cart
                  </button>
                </div>

                <a class="btn btn-link ms-3" href="<%= backHref %>">Back</a>
              </form>
            </div>

            <% if ((success||[]).length) { %>
              <div class="alert alert-success"><%= success.join('<br>') %></div>
            <% } %>

            <% if ((error||[]).length) { %>
              <div class="alert alert-danger"><%= error.join('<br>') %></div>
            <% } %>

          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
