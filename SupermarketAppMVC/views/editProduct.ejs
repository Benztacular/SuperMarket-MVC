<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Edit Product</title>
  <style>
    .edit-card { max-width:880px; margin:28px auto; }
    .preview-img { width:160px; height:160px; object-fit:contain; border:1px solid #e9ecef; border-radius:8px; background:#fff; }
    .form-label { font-weight:600; }
    .muted-note { color:#6c757d; font-size:.9rem; }
    @media (max-width:576px){ .d-flex.gap-3 { flex-direction:column; } .preview-img{width:100%;height:220px} }
  </style>
</head>
<body>
  <%- include('partials/header') %>

  <div class="container edit-card">
    
    <!-- Feedback Messages (Dynamic Logic) -->
    <% if (typeof messages !== 'undefined' && messages) { %>
      <% Object.keys(messages).forEach(function(type){ (messages[type]||[]).forEach(function(msg){ %>
        <div class="alert alert-<%= (type === 'error' ? 'danger' : type) %> alert-dismissible fade show shadow-sm border-0 border-start border-4 border-<%= (type === 'error' ? 'danger' : type) %>" role="alert">
          <%= msg %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% }) }) %>
    <% } %>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">Edit Product</h4>
          <a href="/admin/inventory" class="btn btn-outline-secondary btn-sm">Back to Inventory</a>
        </div>

        <form action="/admin/products/<%= product && product.id %>/edit" method="post" enctype="multipart/form-data" class="row g-3">
          <div class="col-12 col-md-8">
            <label class="form-label">Product name</label>
            <input name="productName" class="form-control" required value="<%= product ? product.productName : '' %>">

            <label class="form-label mt-3">Price</label>
            <input name="price" type="number" step="0.01" class="form-control" required value="<%= (product && product.price != null) ? product.price : '' %>">

            <div class="row">
              <div class="col-7">
                <label class="form-label mt-3">Quantity</label>
                <input name="quantity" type="number" class="form-control" required value="<%= (product && product.quantity != null) ? product.quantity : '' %>">
              </div>
              <div class="col-5">
                <label class="form-label mt-3">Category</label>
                <select id="categorySelect" name="category" class="form-select">
                  <option value="">(no category)</option>
                </select>
                <div class="muted-note mt-1">Select an existing category.</div>
              </div>
            </div>

            <label class="form-label mt-3">Image</label>
            <div class="input-group">
              <input id="imageFile" name="image" type="file" accept="image/*" class="form-control">
              <button id="clearImageBtn" type="button" class="btn btn-outline-secondary" title="Clear selected file">Clear</button>
            </div>

            <!-- preserve existing image filename so update won't remove it when no file is uploaded -->
            <input type="hidden" name="existingImage" value="<%= product && product.image ? product.image : '' %>">
            <div class="muted-note mt-1">Allowed: jpg, png, gif. Leave empty to keep existing image.</div>

            <div class="mt-4 d-flex gap-2">
              <button type="submit" class="btn btn-primary">Save</button>
              <a href="/admin/inventory" class="btn btn-outline-secondary">Cancel</a>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="text-center">
              <div class="mb-2"><strong>Preview</strong></div>
              <% 
                const DEFAULT_IMG = 'https://static.vecteezy.com/system/resources/previews/018/765/757/original/user-profile-icon-in-flat-style-member-avatar-illustration-on-isolated-background-human-permission-sign-business-concept-vector.jpg';
                let imgSrc = DEFAULT_IMG;
                if (product && product.image) {
                  imgSrc = (/^https?:\/\//i.test(product.image)) ? product.image : ('/images/' + product.image);
                }
              %>
              <img id="preview" src="<%= imgSrc %>" alt="image preview" class="preview-img mb-2" onerror="this.onerror=null;this.src='<%= DEFAULT_IMG %>'">
              <div class="muted-note">Currently editing: <strong><%= product ? product.productName : '' %></strong></div>
              <div class="muted-note mt-2">Current category: <strong id="currentCategory"><%= product ? (product.category || '(none)') : '(none)' %></strong></div>

              <!-- server-side values exposed safely to client JS -->
              <div id="serverData" data-current="<%= product && product.category ? product.category : '' %>" data-imgsrc="<%= imgSrc %>" style="display:none"></div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      const sel = document.getElementById('categorySelect');
      const serverData = document.getElementById('serverData');
      const current = serverData ? (serverData.dataset.current || '') : '';
      const imgSrcFromServer = serverData ? (serverData.dataset.imgsrc || '') : '';

      fetch('/api/categories').then(r => r.json()).then(list => {
        list.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          if (c === current) opt.selected = true;
          sel.appendChild(opt);
        });
        if (current && !list.includes(current)) {
          const opt = document.createElement('option');
          opt.value = current;
          opt.textContent = current;
          opt.selected = true;
          sel.appendChild(opt);
        }
        document.getElementById('currentCategory').textContent = sel.value || '(none)';
      }).catch(() => {});

      sel.addEventListener('change', () => {
        document.getElementById('currentCategory').textContent = sel.value || '(none)';
      });

      const fileInput = document.getElementById('imageFile');
      const preview = document.getElementById('preview');
      const clearBtn = document.getElementById('clearImageBtn');

      fileInput.addEventListener('change', (ev) => {
        const f = ev.target.files && ev.target.files[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        preview.src = url;
      });

      clearBtn.addEventListener('click', () => {
        fileInput.value = '';
        // restore current image from server-side value
        preview.src = imgSrcFromServer || '';
      });
    })();
  </script>
  
</body>
</html>